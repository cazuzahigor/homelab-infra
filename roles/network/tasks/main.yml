---
- name: Install ethtool and iw
  ansible.builtin.apt:
    name:
      - ethtool
      - iw
    state: present
    update_cache: true

- name: Deploy sysctl config for IP forwarding
  ansible.builtin.template:
    src: sysctl-tailscale.conf.j2
    dest: /etc/sysctl.d/99-tailscale.conf
    owner: root
    group: root
    mode: '0644'
  notify: Apply sysctl

- name: Ensure networkd-dispatcher routable.d exists
  ansible.builtin.file:
    path: /etc/networkd-dispatcher/routable.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy UDP GRO forwarding script
  ansible.builtin.template:
    src: 50-tailscale.j2
    dest: /etc/networkd-dispatcher/routable.d/50-tailscale
    owner: root
    group: root
    mode: '0755'

- name: Apply UDP GRO forwarding now
  ansible.builtin.command:
    cmd: ethtool -K {{ network_interface }} rx-udp-gro-forwarding on
  changed_when: false

- name: Remove dynamic local IPs from /etc/hosts
  ansible.builtin.blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED â€” internal network"
    state: absent

- name: Disable wifi power save now
  ansible.builtin.command:
    cmd: iw dev {{ network_interface }} set power_save off
  changed_when: false

- name: Deploy netplan Wi-Fi config
  ansible.builtin.template:
    src: 50-cloud-init.yaml.j2
    dest: /etc/netplan/50-cloud-init.yaml
    owner: root
    group: root
    mode: '0600'
  vars:
    wifi_ssid: "{{ vault_wifi_ssid }}"
    wifi_password: "{{ vault_wifi_password }}"
  notify: Apply netplan
